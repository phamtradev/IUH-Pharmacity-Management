name: CD Windows EXE

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows-exe:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Install local swing-toast-notifications (1.0.4 as 1.0.3 & 1.0.2)
        shell: pwsh
        run: |
          if (Test-Path "library/swing-toast-notifications-1.0.4.jar") {
            Write-Host "Installing swing-toast-notifications 1.0.4 as 1.0.3 and 1.0.2"
            mvn -q install:install-file `
              -Dfile=library/swing-toast-notifications-1.0.4.jar `
              -DgroupId=raven.toast `
              -DartifactId=swing-toast-notifications `
              -Dversion=1.0.3 `
              -Dpackaging=jar
            mvn -q install:install-file `
              -Dfile=library/swing-toast-notifications-1.0.4.jar `
              -DgroupId=raven.toast `
              -DartifactId=swing-toast-notifications `
              -Dversion=1.0.2 `
              -Dpackaging=jar
          } else {
            Write-Host "WARNING: library/swing-toast-notifications-1.0.4.jar not found; skipping install-file"
          }

      - name: Build (package)
        shell: pwsh
        run: mvn -B clean package

      - name: Create EXE with jpackage
        shell: pwsh
        run: |
          $appName = "iuhpharmacitymanagement"
          $mainJar = "target/iuhpharmacitymanagement-1.0-SNAPSHOT.jar"
          $mainClass = "vn.edu.iuh.fit.iuhpharmacitymanagement.gui.application.MainApplication"

          if (-not (Test-Path $mainJar)) {
            Write-Error "Main JAR not found at $mainJar"
            exit 1
          }

          New-Item -ItemType Directory -Path dist -Force | Out-Null

          jpackage `
            --type exe `
            --name $appName `
            --input target `
            --main-jar (Split-Path $mainJar -Leaf) `
            --main-class $mainClass `
            --dest dist `
            --win-shortcut `
            --win-dir-chooser

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/*.exe

