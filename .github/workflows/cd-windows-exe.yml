name: CD - Build Windows App Image

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows-app:
    name: Đóng gói ứng dụng Windows 
    runs-on: windows-latest

    steps:
      # ===============================
      # Lấy mã nguồn
      # ===============================
      - name: Lấy mã nguồn
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ===============================
      # Cài đặt Java 21
      # ===============================
      - name: Cài đặt JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      # ===============================
      # Cache các thư viện Maven
      # ===============================
      - name: Cache kho Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      # ===============================
      # Cài đặt thư viện Swing Toast
      # ===============================
      - name: Cài đặt Swing Toast Notifications 
        shell: pwsh
        run: |
          $jar = "library/swing-toast-notifications-1.0.4.jar"

          if (-not (Test-Path $jar)) {
            Write-Error "Không tìm thấy jar cục bộ: $jar"
            exit 1
          }

          mvn install:install-file `
            "-Dfile=$jar" `
            "-DgroupId=raven.toast" `
            "-DartifactId=swing-toast-notifications" `
            "-Dversion=1.0.3" `
            "-Dpackaging=jar"

          mvn install:install-file `
            "-Dfile=$jar" `
            "-DgroupId=raven.toast" `
            "-DartifactId=swing-toast-notifications" `
            "-Dversion=1.0.2" `
            "-Dpackaging=jar"

      # ===============================
      # Build dự án (JAR)
      # ===============================
      - name: Build dự án với Maven (tạo shaded JAR)
        shell: pwsh
        run: mvn -B -DskipTests package

      # ===============================
      # Tạo ứng dụng Windows
      # ===============================
      - name: Tạo ứng dụng Windows (jpackage, sử dụng shaded JAR)
        shell: pwsh
        run: |
          $appName        = "IUH Pharmacity Management"
          $appNameDir     = "IUHPharmacityManagement"
          $appVersion     = "1.0"
          $appDescription = "IUH Pharmacity Management - Hệ thống quản lý nhà thuốc"
          $mainJar        = "target/iuhpharmacitymanagement-1.0-SNAPSHOT-shaded.jar"
          $mainClass      = "vn.edu.iuh.fit.iuhpharmacitymanagement.gui.application.MainApplication"

          if (-not (Test-Path $mainJar)) {
            Write-Error "Không tìm thấy JAR chính: $mainJar"
            exit 1
          }

          # Kiểm tra xem resources có trong JAR không
          Write-Host "Kiểm tra resources trong JAR..."
          $resources = jar tf $mainJar | Select-String "img/"
          if ($resources) {
            Write-Host "Tìm thấy các resources:"
            $resources | ForEach-Object { Write-Host "  $_" }
          } else {
            Write-Warning "Không tìm thấy resources img/ trong JAR!"
          }

          New-Item -ItemType Directory -Path dist -Force | Out-Null

          # Tạo app image với jpackage
          # --input target sẽ copy tất cả file trong target, bao gồm JAR và resources
          # Resources sẽ được tự động extract từ JAR khi chạy ứng dụng
          # --name: tên hiển thị của ứng dụng (có thể có khoảng trắng)
          # Tên thư mục sẽ được tạo tự động từ --name
          jpackage `
            --type app-image `
            --name "$appName" `
            --app-version $appVersion `
            --description "$appDescription" `
            --input target `
            --main-jar (Split-Path $mainJar -Leaf) `
            --main-class $mainClass `
            --dest dist `
            --win-console `
            --java-options "-Dfile.encoding=UTF-8" `
            --java-options "-Djava.awt.headless=false"

      # ===============================
      # Kiểm tra kết quả
      # ===============================
      - name: Kiểm tra thư mục dist
        shell: pwsh
        run: Get-ChildItem -Recurse dist

      # ===============================
      # Tải lên Artifact
      # ===============================
      - name: Tải lên ứng dụng Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-app-image
          path: dist/**

      # ===============================
      # Create tag and GitHub release (upload dist/**)
      # ===============================
      - name: Get version
        id: version
        shell: pwsh
        run: |
          [xml]$pom = Get-Content pom.xml
          echo "v=$($pom.project.version)" >> $env:GITHUB_OUTPUT

      - name: Create git tag
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "v${{ steps.version.outputs.v }}"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -f $tag
          git push -f "https://x-access-token:${env:GITHUB_TOKEN}@github.com/${{ github.repository }}" $tag

      - name: Create GitHub Release and upload dist artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.v }}
          files: dist/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}