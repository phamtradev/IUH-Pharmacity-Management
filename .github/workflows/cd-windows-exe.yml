name: CD - Build Windows EXE

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows-exe:
    name: Build Windows EXE (WiX enabled)
    runs-on: windows-latest

    steps:
      # ===============================
      # Checkout
      # ===============================
      - name: Checkout source code
        uses: actions/checkout@v4

      # ===============================
      # Java 21
      # ===============================
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      # ===============================
      # Install WiX Toolset + add to PATH
      # ===============================
      - name: Install WiX Toolset
        shell: pwsh
        run: |
          choco install wixtoolset -y --no-progress
          $wixPath = "C:\Program Files (x86)\WiX Toolset v3.11\bin"
          echo $wixPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          light.exe -?

      # ===============================
      # Cache Maven
      # ===============================
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}

      # ===============================
      # Install local toast JAR (2 versions)
      # ===============================
      - name: Install Swing Toast Notifications
        shell: pwsh
        run: |
          $jar = "library/swing-toast-notifications-1.0.4.jar"
          if (-not (Test-Path $jar)) {
            Write-Error "Toast jar not found"
            exit 1
          }

          mvn install:install-file `
            "-Dfile=$jar" `
            "-DgroupId=raven.toast" `
            "-DartifactId=swing-toast-notifications" `
            "-Dversion=1.0.3" `
            "-Dpackaging=jar"

          mvn install:install-file `
            "-Dfile=$jar" `
            "-DgroupId=raven.toast" `
            "-DartifactId=swing-toast-notifications" `
            "-Dversion=1.0.2" `
            "-Dpackaging=jar"

      # ===============================
      # Build project
      # ===============================
      - name: Build project
        shell: pwsh
        run: mvn -B verify

      # ===============================
      # Build Windows EXE with jpackage
      # ===============================
      - name: Create Windows EXE
        shell: pwsh
        run: |
          $appName   = "iuhpharmacitymanagement"
          $version   = "1.0.0"
          $mainJar   = "target/iuhpharmacitymanagement-1.0-SNAPSHOT.jar"
          $mainClass = "vn.edu.iuh.fit.iuhpharmacitymanagement.gui.application.MainApplication"

          if (-not (Test-Path $mainJar)) {
            Write-Error "Main JAR not found"
            exit 1
          }

          New-Item -ItemType Directory -Path dist -Force | Out-Null

          jpackage `
            --type exe `
            --name $appName `
            --app-version $version `
            --input target `
            --main-jar (Split-Path $mainJar -Leaf) `
            --main-class $mainClass `
            --dest dist `
            --win-console `
            --win-shortcut `
            --win-dir-chooser

      # ===============================
      # Debug
      # ===============================
      - name: Debug dist folder
        shell: pwsh
        run: Get-ChildItem -Recurse dist

      # ===============================
      # Upload Artifact
      # ===============================
      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/**
